---
- name: Create Kafka data directory with correct permissions
  file:
    path: "{{ kafka_data_dir }}"
    state: directory
    mode: '0755'
    owner: 1000  # Confluent 'appuser' UID
    group: 1000

- name: Create Docker Compose working directory
  file:
    path: "/opt/kafka-docker"
    state: directory

- name: Deploy docker-compose.yml template
  template:
    src: docker-compose.yml.j2
    dest: "/opt/kafka-docker/docker-compose.yml"
    mode: '0644'
  register: compose_config  # [핵심] 실행 결과를 'compose_config' 변수에 저장

# 설정 파일이 변경되었을 때만 기존 컨테이너를 내림
- name: Tear down existing services (only if config changed)
  command: docker compose down
  args:
    chdir: "/opt/kafka-docker"
  when: compose_config.changed  # [핵심] 변경 감지 시 실행

- name: Pull Docker images
  command: docker compose pull
  args:
    chdir: "/opt/kafka-docker"

- name: Start Kafka Cluster (and UI on server-4)
  command: docker compose up -d
  args:
    chdir: "/opt/kafka-docker"
